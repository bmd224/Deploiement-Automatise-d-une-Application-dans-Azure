# Déploiement API
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: api-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: api
    template:
      metadata:
        labels:
          app: api
      spec:
        containers:
          - name: api
            image: galiregistry.azurecr.io/api:latest
            ports:
              - containerPort: 8080
            env:
              - name: AppConfigurationEndpoints
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AppConfigurationEndpoints
              - name: AZURE_CLIENT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_ID
              - name: AZURE_TENANT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_TENANT_ID
              - name: AZURE_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_SECRET

# Autoscaler API (CPU)
- apiVersion: autoscaling/v2
  kind: HorizontalPodAutoscaler
  metadata:
    name: api-deployment-hpa
  spec:
    scaleTargetRef:
      apiVersion: apps/v1
      kind: Deployment
      name: api-deployment
    minReplicas: 1
    maxReplicas: 5
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 60

# Déploiement MVC
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: mvc-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: mvc
    template:
      metadata:
        labels:
          app: mvc
      spec:
        containers:
          - name: mvc
            image: galiregistry.azurecr.io/mvc:latest
            ports:
              - containerPort: 8081
            resources:
              requests:
                cpu: "100m"
              limits:
                cpu: "500m"
            env:
              - name: AppConfigurationEndpoints
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AppConfigurationEndpoints
              - name: AZURE_CLIENT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_ID
              - name: AZURE_TENANT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_TENANT_ID
              - name: AZURE_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_SECRET

# Déploiement Worker_Content
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: worker-content-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: worker-content
    template:
      metadata:
        labels:
          app: worker-content
      spec:
        containers:
          - name: worker-content
            image: galiregistry.azurecr.io/worker_content:latest
            env:
              - name: AppConfigurationEndpoints
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AppConfigurationEndpoints
              - name: AZURE_CLIENT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_ID
              - name: AZURE_TENANT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_TENANT_ID
              - name: AZURE_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_SECRET
              - name: SERVICE_BUS_CONNECTION
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: ConnectionStringSB

# ScaledObject Worker_Content (KEDA Service Bus)
- apiVersion: keda.sh/v1alpha1
  kind: ScaledObject
  metadata:
    name: worker-content-scaler
  spec:
    scaleTargetRef:
      kind: Deployment
      name: worker-content-deployment
    pollingInterval: 15
    cooldownPeriod: 30
    minReplicaCount: 1
    maxReplicaCount: 5
    triggers:
      - type: azure-servicebus
        metadata:
          namespace: galiSb
          queueName: contentsafetymessage
          queueLength: "1" # Strict pour scaler rapidement
          connectionFromEnv: SERVICE_BUS_CONNECTION

# Déploiement Worker_Image
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: worker-image-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: worker-image
    template:
      metadata:
        labels:
          app: worker-image
      spec:
        containers:
          - name: worker-image
            image: galiregistry.azurecr.io/worker_image:latest
            env:
              - name: AppConfigurationEndpoints
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AppConfigurationEndpoints
              - name: AZURE_CLIENT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_ID
              - name: AZURE_TENANT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_TENANT_ID
              - name: AZURE_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_SECRET
              - name: SERVICE_BUS_CONNECTION
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: ConnectionStringSB

# ScaledObject Worker_Image (KEDA Service Bus)
- apiVersion: keda.sh/v1alpha1
  kind: ScaledObject
  metadata:
    name: worker-image-scaler
  spec:
    scaleTargetRef:
      kind: Deployment
      name: worker-image-deployment
    pollingInterval: 15
    cooldownPeriod: 30
    minReplicaCount: 1
    maxReplicaCount: 5
    triggers:
      - type: azure-servicebus
        metadata:
          namespace: galiSb
          queueName: imageresizemessage
          queueLength: "1" # encore pour scaler 
          connectionFromEnv: SERVICE_BUS_CONNECTION

# Déploiement Worker_DB
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: worker-db-deployment
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: worker-db
    template:
      metadata:
        labels:
          app: worker-db
      spec:
        containers:
          - name: worker-db
            image: galiregistry.azurecr.io/worker_db:latest
            env:
              - name: AppConfigurationEndpoints
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AppConfigurationEndpoints
              - name: AZURE_CLIENT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_ID
              - name: AZURE_TENANT_ID
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_TENANT_ID
              - name: AZURE_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: AZURE_CLIENT_SECRET
              - name: EVENT_HUB_CONNECTION
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: ConnectionStringEventHub
              - name: STORAGE_CONNECTION
                valueFrom:
                  secretKeyRef:
                    name: my-secret
                    key: ConnectionStringBlob

# ScaledObject Worker_DB (KEDA Event Hub)
- apiVersion: keda.sh/v1alpha1
  kind: ScaledObject
  metadata:
    name: worker-db-scaler
  spec:
    scaleTargetRef:
      kind: Deployment
      name: worker-db-deployment
    pollingInterval: 15
    cooldownPeriod: 30
    minReplicaCount: 1
    maxReplicaCount: 5
    triggers:
      - type: azure-eventhub
        metadata:
          eventHubName: event
          eventHubConsumerGroup: consumer
          blobContainer: synchro
          connectionFromEnv: EVENT_HUB_CONNECTION
          storageConnectionFromEnv: STORAGE_CONNECTION

# Services API et MVC
- apiVersion: v1
  kind: Service
  metadata:
    name: api-service
  spec:
    type: LoadBalancer
    ports:
      - port: 8080
        targetPort: 8080
    selector:
      app: api

- apiVersion: v1
  kind: Service
  metadata:
    name: mvc-service
  spec:
    type: LoadBalancer
    ports:
      - port: 8081
        targetPort: 8081
    selector:
      app: mvc
